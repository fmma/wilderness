#include "Model.h"

#include <stdio.h>
#include <Math.h>
#include <cstdlib>

inline float randf() {
    return (float)rand()/(float)(RAND_MAX);
}

float normalf() {
    float x = 0.0f;
    for(int i = 0; i < 12; ++i) {
        x += randf();
    }
    return x - 6.0f;
}

void stencil() {
    
}

void Model::generateMap() {
    this->heightmap = new float[width * height];
    this->trees = new bool[width * height];
    srand(this->seed);
    
    for(int y = 0; y < height; ++y) {
        for(int x = 0; x < width; ++x) {
            heightmap[x + y*width] = 0.9f * (waterHeight - heightMin) / (heightMax - heightMin) + (randf() - 0.5f) / 4.0f;
        }
    }
    for(int i = 0; i < 50; ++i) {
        int x = floorf(randf() * width);
        int y = floorf(randf() * height);
        heightmap[x + y*width] = 1.0f;
        for(int j = 0; j < 100; ++j) {
            int dx = floorf(normalf() * 10) - 5;
            int dy = floorf(normalf() * 10) - 5;
            int x0 = x + dx;
            int y0 = y + dy;
            setHeight(x0, y0, 1.0f);
        }
    }

    float stencil[] = 
        { 1.0f, 2.0f, 1.0f,
          2.0f, 4.0f, 2.0f,
          1.0f, 2.0f, 1.0f
        };
    smoothHeights(3, stencil, 3);

    // Rescale
    /*
    float minH = this->heightMax;
    float maxH = this->heightMin;
    
    for(int y = 1; y < height - 1; ++y) {
        for(int x = 1; x < width - 1; ++x) {
            minH = minH < map[x + y * width].height ? minH : map[x + y * width].height;
            maxH = maxH > map[x + y * width].height ? maxH : map[x + y * width].height;
        }
    }
    float range = maxH - minH;
    */
    for(int i = 0; i < this->width * this->height; ++i) {
        heightmap[i] = heightmap[i] * (this->heightMax - this->heightMin) + this->heightMin;
    }    

/*
    for(int i = 0; i < this->width * this->height; ++i) {
        if(this->map[i].height > this->waterHeight && this->map[i].height <= this->treeLimit) {
            this->map[i].tree = randf() <= this->treeProp ? 1 : 0;
        }
    }
    */
}


void Model::smoothHeights(int iterations, float *stencil, int stencilSize) {
    int center = stencilSize / 2;
    for(int k = 0; k < iterations; ++k) {
        float newHeights[width * height];
        for(int j = 0; j < height; ++j) {
            for(int i = 0; i < width; ++i) {
                float x = 0.0f;
                float w = 0.0f;
                for(int jj = 0; jj < stencilSize; ++jj) {
                    for(int ii = 0; ii < stencilSize; ++ii) {
                        int iii = i + ii - center;
                        int  jjj = j + jj - center;
                        if(iii >= 0 && iii < width && jjj >= 0 && jjj < height) {
                            float wij = stencil[ii + jj*stencilSize];
                            w += wij;
                            x += wij * heightmap[iii + (jjj) * width];
                        }
                    }
                }
                newHeights[i + j * width] = x / w;
            }
        }
        for(int i = 0; i < width * height; ++i) {
            heightmap[i] = newHeights[i];
        }
    }
}
void Model::renderMap(View *view) {
    char shades[] = "  " // "~~"
    /*
  000    010    000    010    000    010    000    010    000    010    000    010    000    010    000    010  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  000    000    000    000    000    000    000    000    010    010    010    010    010    010    010    010  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  100    110    100    110    100    110    100    110    100    110    100    110    100    110    100    110  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  000    000    000    000    000    000    000    000    010    010    010    010    010    010    010    010  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  001    011    001    011    001    011    001    011    001    011    001    011    001    011    001    011  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  000    000    000    000    000    000    000    000    010    010    010    010    010    010    010    010  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  101    111    101    111    101    111    101    111    101    111    101    111    101    111    101    111  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  000    000    000    000    000    000    000    000    010    010    010    010    010    010    010    010  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  000    010    000    010    000    010    000    010    000    010    000    010    000    010    000    010  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  100    100    100    100    100    100    100    100    110    110    110    110    110    110    110    110  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  100    110    100    110    100    110    100    110    100    110    100    110    100    110    100    110  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  100    100    100    100    100    100    100    100    110    110    110    110    110    110    110    110  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  001    011    001    011    001    011    001    011    001    011    001    011    001    011    001    011  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  100    100    100    100    100    100    100    100    110    110    110    110    110    110    110    110  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  101    111    101    111    101    111    101    111    101    111    101    111    101    111    101    111  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  100    100    100    100    100    100    100    100    110    110    110    110    110    110    110    110  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  000    010    000    010    000    010    000    010    000    010    000    010    000    010    000    010  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  001    001    001    001    001    001    001    001    011    011    011    011    011    011    011    011  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  100    110    100    110    100    110    100    110    100    110    100    110    100    110    100    110  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  001    001    001    001    001    001    001    001    011    011    011    011    011    011    011    011  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  001    011    001    011    001    011    001    011    001    011    001    011    001    011    001    011  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  001    001    001    001    001    001    001    001    011    011    011    011    011    011    011    011  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  101    111    101    111    101    111    101    111    101    111    101    111    101    111    101    111  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  001    001    001    001    001    001    001    001    011    011    011    011    011    011    011    011  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  000    010    000    010    000    010    000    010    000    010    000    010    000    010    000    010  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  101    101    101    101    101    101    101    101    111    111    111    111    111    111    111    111  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  100    110    100    110    100    110    100    110    100    110    100    110    100    110    100    110  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  101    101    101    101    101    101    101    101    111    111    111    111    111    111    111    111  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  001    011    001    011    001    011    001    011    001    011    001    011    001    011    001    011  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  101    101    101    101    101    101    101    101    111    111    111    111    111    111    111    111  */
  "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??"   "??" 
/*
  101    111    101    111    101    111    101    111    101    111    101    111    101    111    101    111  
  0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1    0 0    0 0    1 0    1 0    0 1    0 1    1 1    1 1  
  101    101    101    101    101    101    101    101    111    111    111    111    111    111    111    111  */
  "<>"   "\\/"  "~>"   "_/"   "<~"   "\\_"  "||"   "__"   "/\\"  "=="   "`\\"  "~|"   "/`"   "|~"   "``"   "~~" 

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "()"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   
/*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   
/*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   
/*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "=="   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "__"   
/*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   
/*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   
/*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   
/*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   
/*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "||"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   
/*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   
/*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   
/*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   
/*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   
/*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   
/*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   
/*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "~~"   
/*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   
/*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   
/*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   
/*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   
/*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   
/*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   
/*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   
/*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "__"   
/*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   
/*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   
/*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "/`"   /*0 1*/ "/`"   /*0 1*/ "|~"   /*0 1*/ "|~"   /*0 1*/ "/`"   /*0 1*/ "/`"   /*0 1*/ "|~"   /*0 1*/ "|~"   
/*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "``"   /*1 1*/ "``"   /*1 1*/ "~~"   /*1 1*/ "~~"   /*1 1*/ "``"   /*1 1*/ "``"   /*1 1*/ "~~"   /*1 1*/ "~~"   
/*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "/\\"  /*0 0*/ "\\\\" /*0 0*/ "||"   /*0 0*/ "||"   /*0 0*/ "//"   /*0 0*/ "||"   /*0 0*/ "|/"   /*0 0*/ "><"   
/*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "`\\"  /*1 0*/ "`\\"  /*1 0*/ "~|"   /*1 0*/ "~|"   /*1 0*/ "`\\"  /*1 0*/ "`\\"  /*1 0*/ "~|"   /*1 0*/ "~|"   
/*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "/`"   /*0 1*/ "/`"   /*0 1*/ "|~"   /*0 1*/ "|~"   /*0 1*/ "/`"   /*0 1*/ "/`"   /*0 1*/ "|~"   /*0 1*/ "|~"   
/*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "``"   /*1 1*/ "``"   /*1 1*/ "~~"   /*1 1*/ "~~"   /*1 1*/ "``"   /*1 1*/ "``"   /*1 1*/ "~~"   /*1 1*/ "~~"   
/*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        

///////////////////

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "##"   /*0 0*/ "/#"   /*0 0*/ "__"   /*0 0*/ "__"   /*0 0*/ "#\\"  /*0 0*/ "/\\"  /*0 0*/ "__"   /*0 0*/ "__"   
/*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "|#"   /*1 0*/ "|#"   /*1 0*/ "~_"   /*1 0*/ "~_"   /*1 0*/ "|\\"  /*1 0*/ "|\\"  /*1 0*/ "~_"   /*1 0*/ "~_"   
/*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "#|"   /*0 1*/ "/|"   /*0 1*/ "_~"   /*0 1*/ "_~"   /*0 1*/ "#|"   /*0 1*/ "/|"   /*0 1*/ "_~"   /*0 1*/ "_~"   
/*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "||"   /*1 1*/ "|/"   /*1 1*/ "o~"   /*1 1*/ "o~"   /*1 1*/ "\\|"  /*1 1*/ "||"   /*1 1*/ "~o"   /*1 1*/ "~o"   
/*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        /*000*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "\\#"  /*0 0*/ "=#"   /*0 0*/ "\\_"  /*0 0*/ "\\_"  /*0 0*/ "\\\\" /*0 0*/ "=\\"  /*0 0*/ "\\_"  /*0 0*/ "\\_"  
/*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "|#"   /*1 0*/ "|#"   /*1 0*/ "~_"   /*1 0*/ "~_"   /*1 0*/ "|\\"  /*1 0*/ "|\\"  /*1 0*/ "~_"   /*1 0*/ "~_"   
/*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "\\|"  /*0 1*/ "=|"   /*0 1*/ "\\~"  /*0 1*/ "\\~"  /*0 1*/ "\\|"  /*0 1*/ "=|"   /*0 1*/ "\\~"  /*0 1*/ "\\~"   
/*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "\\|"  /*1 1*/ "||"   /*1 1*/ "~|"   /*1 1*/ "~|"   /*1 1*/ "\\\\" /*1 1*/ "|\\"  /*1 1*/ "~o"   /*1 1*/ "~o"   
/*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        /*100*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "``"   /*0 0*/ "/`"   /*0 0*/ "=="   /*0 0*/ "=="   /*0 0*/ "`\\"  /*0 0*/ "??"   /*0 0*/ "=="   /*0 0*/ "=="   
/*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "~\\"  /*1 0*/ "~\\"  /*1 0*/ "~|"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   
/*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "`~"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   
/*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "\\/"  /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   
/*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        /*010*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "``"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   
/*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "~`"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "~|"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   
/*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "`~"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   
/*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   
/*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        /*110*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "#/"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "#="   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   
/*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "|/"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   
/*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "#|"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   
/*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "||"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   
/*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        /*001*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "\\/"  /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   
/*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "|/"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   
/*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "\\|"  /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   
/*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "||"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "~o"   
/*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        /*101*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "``"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   
/*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "|`"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   
/*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "`~"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   
/*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "|~"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   
/*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        /*011*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 0*/ "``"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   /*0 0*/ "??"   
/*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 0*/ "~`"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   /*1 0*/ "??"   
/*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*0 1*/ "`~"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   /*0 1*/ "??"   
/*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        

/*000*/        /*100*/        /*010*/        /*110*/        /*001*/        /*101*/        /*011*/        /*111*/        
/*1 1*/ "``"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "??"   /*1 1*/ "``"   /*1 1*/ "o~"   /*1 1*/ "o~"   /*1 1*/ "o~"   
/*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        /*111*/        

        /*   0 */ "##" "/#" "__" "__" "#\\" "||" "__" "__" 
        /*   8 */ "|#" "|#" "~_" "~_" "??" "??" "??" "~_"
        /*  16 */ "#|" "??" "??" "??" "#|" "??" "_~" "_~"
        /*  24 */ "??" "??" "??" "??" "??" "??" "??" "__"

        /*  32 */ "\\#" "??" "??" "??" "??" "??" "??" "??"
        /*  40 */ "|#" "|#" "??" "~_" "??" "??" "??" "~_"
        /*  48 */ "??" "??" "??" "??" "??" "??" "??" "??" 
        /*  56 */ "??" "??" "??" "??" "??" "??" "??" "??"

        /*  64 */ "\"\"" "??" "??" "??" "??" "??" "??" "??" 
        /*  72 */ "~\"" "~\"" "??" "??" "??" "??" "??" "??"
        /*  80 */ "??" "??" "??" "??" "??" "??" "??" "??" 
        /*  88 */ "??" "??" "??" "??" "??" "??" "??" "??"

        /*  96 */ "\"\"" "??" "??" "??" "??" "??" "??" "??" 
        /* 104 */ "~\"" "~\"" "??" "??" "??" "??" "??" "??"
        /* 112 */ "\"~" "??" "??" "??" "??" "??" "??" "??" 
        /* 120 */ "??" "??" "??" "??" "??" "??" "??" "??"

        /* 128 */ "#/" "??" "??" "??" "??" "??" "??" "??" 
        /* 136 */ "??" "??" "??" "??" "??" "??" "??" "??"
        /* 144 */ "#|" "??" "??" "??" "#|" "??" "_~" "_~" 
        /* 152 */ "??" "??" "??" "??" "??" "??" "??" "??"

        /* 160 */ "??" "??" "??" "??" "??" "??" "??" "??" 
        /* 168 */ "??" "??" "??" "??" "??" "??" "??" "??"
        /* 176 */ "??" "??" "??" "??" "??" "??" "??" "??" 
        /* 184 */ "??" "??" "??" "??" "??" "??" "??" "??"

        /* 192 */ "\"\"" "??" "??" "??" "??" "??" "??" "??" 
        /* 200 */ "~\"" "~\"" "??" "??" "??" "??" "??" "??"
        /* 208 */ "\"~" "??" "??" "??" "\"~" "??" "??" "??" 
        /* 216 */ "??" "??" "??" "??" "??" "??" "??" "??"

        /* 224 */ "\"\"" "??" "??" "??" "??" "??" "??" "??" 
        /* 232 */ "~\"" "~\"" "??" "??" "??" "??" "??" "<="
        /* 240 */ "\"~" "??" "??" "??" "\"~" "??" "??" "=>" 
        /* 248 */ "??" "??" "??" "??" "??" "??" "??" "<>";
    /*
        001
        000
        000

        ~~~~|#
        ___/
                ~~||~~
                ==##==
                ~~||~~
    */
    int nShades = (sizeof(shades) / sizeof(char) - 1) / 2;
    int x = roundf(player.x) - view->width / 2;
    int y = roundf(player.y) - view->height / 2;
    for(int r = 1; r < view->height - 1; ++r) {
        for(int c = 1; c < view->width - 2; c += 2) {
            int ry = r + y;
            int cx = c / 2 + x;
            if(ry >= 0 && cx >= 0 && ry < this->width && cx < this->height) {
                int i = cx + ry * width;
                /*
                char terrain = cell.height <= 0 
                    ? '~'
                    : cell.tree
                    ? '$'
                    : cell.height >= this->treeLimit
                    ? '^'
                    : ' ';
                */
               int shadeIndex = heightmap[i] <= waterHeight
                ? 0
                : heightmap[i] <= treeLimit
                ? 1
                : 2;
                /*
                ~~~~~~
                ~~o~~~
                ~~~~~~

                ~~~~__
                ~~==##
                ~~~~||

                ~~~~~~~~~~
                ~~~____~~~
                ~~|####|~~
                ~~~""""~~~
                ~~~~~~~~~~
                ~~~~~~~~~~

                ~~~~~~
                ~~o~~~
                ~~~~~~

                ~~|###
                __/###
                ######

                */
                shadeIndex = 
                    heightmap[i] < waterHeight ? 0 : 
                    1 +
                    ((heightmap[i     - width] >= waterHeight) << 0) +
                    ((heightmap[i - 1        ] >= waterHeight) << 1) +
                    ((heightmap[i + 1        ] >= waterHeight) << 2) +
                    ((heightmap[i     + width] >= waterHeight) << 3) +
                    ((heightmap[i - 1 - width] >= waterHeight || 1) << 4) +
                    ((heightmap[i + 1 - width] >= waterHeight || 1) << 5) +
                    ((heightmap[i - 1 + width] >= waterHeight || 1) << 6) +
                    ((heightmap[i + 1 + width] >= waterHeight || 1) << 7);

                // int shadeIndex = (int)((cell.height - heightMin) / (heightMax - heightMin) * (nShades - 1));
                if(shadeIndex > nShades || shadeIndex < 0)
                {
                    printf("Error shade index: %d, height:%f\n", shadeIndex, heightmap[i]);
                    exit(1);
                }
                view->writeChar(c, r, shades[2*shadeIndex]);
                view->writeChar(c+1, r, shades[2*shadeIndex+1]);
            }
            else {
                view->writeChar(c, r, ' ');
                view->writeChar(c+1, r, ' ');
            }
        }
    }
}
